<?php/* * Simvc PHP Framework * Copyright 2010, Eugene Maslovich * ehpc@yandex.ru * http://ehpc.org.ru/simvcframework/ * */// Extract file name from path (without extension)function getFileName($path){    $fileName = basename($path);    $pos = strrpos($fileName, '.');    if ($pos === false)    {        return $fileName;    }    else    {        $baseName = substr($fileName, 0, $pos);        return $baseName;    }}// Dispose array of empty valuesfunction clearArray($array){    $clearedArray = array();    foreach ($array as $value)    {        if (!empty($value))        {            $clearedArray[] = $value;        }    }    return $clearedArray;}// Removes server root hierarchy from pathfunction stripRootDir($dir){    $dir = str_replace("\\", "/", $dir);    return str_replace(str_replace("\\", "/", $_SERVER['DOCUMENT_ROOT']), "", $dir);}// Autoloading classesfunction autoloadSimvc($className){    $result = @include __DIR__."/".lcfirst($className).'.php';}spl_autoload_register("autoloadSimvc");function autoloadControllers($className){    $classDir = ''.strtolower($className).'/';    set_include_path(get_include_path().PATH_SEPARATOR.$classDir);    $result = @include $classDir.strtolower($className).'.php';}spl_autoload_register("autoloadControllers");class Simvc{    private $params = array(); // Uri parameters; Ex: /blog/:id    private $variables = array(); // User variables accessible anywhere    private $styles = array(); // Contains css uris    private $scripts = array(); // Contains js uris    public $pageTitle = "Simvc default title";    public $errorPageTitle = "Simvc default error title";    public $errorTemplatePath = "error.html";    public $layoutBodyTemplatePath = "";    public $layoutTemplatePath = "layout.html";    public $uriCss = "/public/css/"; // Uri of public folder where css are stored    public $uriJs = "/public/js/"; // Uri of public folder where js are stored    public $uriImages = "/public/images/"; // Uri of public folder where images are stored    public $uriSimvc = "/simvc/";    public $uri = ""; // Uri by which this Simvc instance is accessed    public $controllerPath = "";    public $navigation;    public $model;    public $auth;    public $routeTable = array();    function  __construct()    {        $this->navigation = new SimvcNavigation($this);    }    function setupDb($modelDsn, $modelUser = "", $modelPassword = "")    {        $this->model = new SimvcModel($this, $modelDsn, $modelUser, $modelPassword);        $this->auth = new SimvcAuth($this);    }    // Converts value to suitable output for dynomagic javascript input    // using JSON and object notation    public function dynomagicOutput($var, $table = null)    {        $res = "{}";        if ($table !== null)        {            $arr = array();            foreach ($var->getIterator() as $key => $value)            {                $arr[$key] = $value;            }            $res = (object)array("db"=>(object)array($table=>(object)$arr));            $res = json_encode($res);        }        else        {            $res = json_encode($var);        }        header('Cache-Control: no-cache, must-revalidate');        header('Expires: Mon, 26 Jul 1997 05:00:00 GMT');        header('Content-type: application/json');        echo $res;    }    // get uri components (text between '/')    public function uriPartial($n = null)    {        preg_match_all('/[^\/]+/', $this->uri, $matches);        if ($n !== null)        {            return $matches[0][$n];        }        else        {            return $matches;        }    }    // Getter and setter for user variables    public function data($varName, $varValue = null)    {        if ($varValue != null)        {            $this->variables[$varName] = $varValue;        }        else        {            if (array_key_exists($varName, $this->variables))            {                return $this->variables[$varName];            }            else            {                return null;            }        }    }    // Getter and setter for session variables    public function session($varName, $varValue = null, $unset = false)    {        if ($unset)        {            unset($_SESSION[$varName]);        }        else        {            if ($varValue != null)            {                $_SESSION[$varName] = $varValue;            }            else            {                if (array_key_exists($varName, $_SESSION))                {                    return $_SESSION[$varName];                }                else                {                    return null;                }            }        }    }    // Output template inplace    public function template($templatePath, $partial = true, $defaults = true)    {        if ($defaults)        {            // Try to add default style if one exists            $defaultStyle = $this->controllerPath."/".getFileName($templatePath).".css";            if (file_exists($defaultStyle))            {                $this->addStyle(stripRootDir($this->controllerPath)."/".getFileName($templatePath).".css");            }            // Try to add default script if one exists            $defaultScript = $this->controllerPath."/".getFileName($templatePath).".js";            if (file_exists($defaultScript))            {                $this->addScript(stripRootDir($this->controllerPath)."/".getFileName($templatePath).".js");            }        }        $this->layoutBodyTemplate = $templatePath;        if ($partial)        {            include $this->layoutTemplatePath;        }        else        {            include $templatePath;        }    }    public function addStyle($cssUri)    {        if (!in_array($cssUri, $this->styles))        {            $this->styles[] = $cssUri;        }    }    public function addScript($scriptUri)    {        if (!in_array($scriptUri, $this->scripts))        {            $this->scripts[] = $scriptUri;        }    }    // Returns html-head-compatible string of all styles    public function styles()    {        $result = "";        foreach ($this->styles as $style)        {            $result .= '<link rel="stylesheet" type="text/css" href="'.$style.'" />'."\n";        }        return $result;    }    // Returns html-head-compatible string of all scripts    public function scripts()    {        $result = "";        foreach ($this->scripts as $script)        {            $result .= '<script type="text/javascript" src="'.$script.'"></script>'."\n";        }        return $result;    }        // Matches supplied uri with available actions    private function findAction($method, $uri)    {        foreach ($this->routeTable as $route)        {            // Example: route('GET', '/blog/:id', ...            if ((!empty($route['route'])) && ($method == $route['method']))            {                // Making regular expression out of route                // WARNING: may be problems with regex special chars                $replacePatterns = array('/\:([^\/]+)/', '/\*/', '/\//');                $replaceStrings = array('(?P<$1>.+)', '(.+)', '\\/');                $routePattern = '/^'.preg_replace($replacePatterns, $replaceStrings, $route['route']).'$/';                preg_match_all($routePattern, $uri, $routeMatches);                if (!empty($routeMatches[0][0]))                {                    $this->uri = $uri;                    $this->params = $routeMatches;                    return array('action'=>$route['action']);                }            }        }        return false;    }        // Returns resolved variable from route    public function param($name)    {        if (array_key_exists($name, $this->params))        {            return $this->params[$name][0];        }        else        {            return false;        }    }        // Adds route to table    public function route($method, $route, $action)    {        $this->routeTable[] = array('method'=>$method, 'route'=>$route, 'action'=>$action);    }    public function call($action)    {        // Assume it is 'Class::Method' action        if (strpos($action, '::') !== false)        {            $arr = explode('::', $action);            $controller = new $arr[0]($this);            $class_info = new ReflectionClass($controller);            $controller->contollerPath = dirname($class_info->getFileName());            $this->controllerPath = dirname($class_info->getFileName());            $controller->$arr[1]();            return true;        }        else        {            return false;        }    }    // Main routine    public function run()    {        session_start();        set_include_path(get_include_path().PATH_SEPARATOR.__DIR__);        $this->addStyle($this->uriSimvc."css/reset.css");        $this->addStyle($this->uriSimvc."css/sh/shCore.css");        $this->addStyle($this->uriSimvc."css/sh/shThemeDefault.css");        $this->addStyle($this->uriSimvc."css/dynomagic.css");        $this->addStyle($this->uriCss."global.css");        $this->addScript($this->uriSimvc."js/jquery.js");        $this->addScript($this->uriJs."global.js");        $this->addScript($this->uriSimvc."js/dynomagic.js");        $this->addScript($this->uriSimvc."js/progress.js");        $this->addScript($this->uriSimvc."js/jquery.textarearesizer.js");        $this->addScript($this->uriSimvc."js/text.transform.js");        $this->addScript($this->uriSimvc."js/sh/shCore.js");        $this->addScript($this->uriSimvc."js/sh/shBrushJScript.js");        $this->addScript($this->uriSimvc."js/sh/shBrushPhp.js");        $this->addScript($this->uriSimvc."js/sh/shBrushCSharp.js");        $this->addScript($this->uriSimvc."js/sh/shBrushCss.js");        // Execute action if any        $action = $this->findAction($_SERVER['REQUEST_METHOD'], $_SERVER['REQUEST_URI']);        if ($action)        {            $this->call($action['action']);        }        else        {            $this->controllerPath = __DIR__;            $this->pageTitle = $this->errorPageTitle;            $this->addStyle($this->uriCss."error.css");            $this->template($this->errorTemplatePath, $partial = true, $defaults = false);        }    }    function redirect($uri)    {        header("Location: ".$uri);    }}